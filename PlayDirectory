#!/usr/bin/env zsh

# PlayDirectory: play all .m4a files under a directory, with skip + quit keys

skip=0

# --- parse args --------------------------------------------------------------
while getopts "s:" opt; do
    case "$opt" in
        s)
            skip=$OPTARG
            ;;
        *)
            echo "Usage: $0 [-s <n>] <directory>"
            exit 1
            ;;
    esac
done
shift $((OPTIND - 1))

root="$1"

if [[ -z "$root" || ! -d "$root" ]]; then
    echo "Usage: $0 [-s <n>] <directory>"
    exit 1
fi

# --- walk & play -------------------------------------------------------------
count=0

find "$root" -type f -name '*.m4a' -print0 |
while IFS= read -r -d '' file; do
    [[ -z "$file" ]] && continue

    # Skip first N files
    if (( count < skip )); then
        ((count++))
        continue
    fi

    ((count++))

    echo
    echo "Playing: $file"
    afplay "$file" &
    pid=$!

    # Wait while the process is alive, watching keyboard
    while kill -0 "$pid" 2>/dev/null; do
        if read -k 1 -t 0.1 key; then
            case "$key" in
                s|S)
                    echo "  -> skip"
                    kill "$pid" 2>/dev/null
                    ;;
                q|Q)
                    echo "  -> quit"
                    kill "$pid" 2>/dev/null
                    exit 0
                    ;;
            esac
        fi
    done
done